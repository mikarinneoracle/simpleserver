box:
    id: node
    tag: 6.10

build:
  steps:
    - npm-install
deploy:
  steps:
    - internal/docker-push:
      username: $OCIR_USERNAME
      password: $OCIR_PASSWORD
      tag: $WERCKER_MAIN_PIPELINE_STARTED
      repository: fra.ocir.io/sefinland/mrinne/simpleserver
      ports: "3000"
      working-dir: /pipeline/source
      cmd: npm start
      registry: https://fra.ocir.io
sed:
  steps:
    - script:
        name: sed-image-tag
        code: |
          git config --global user.email "mika.rinne@oracle.com"
          git config --global user.name "Mika Rinne"
          git remote add backtorepo git@github.com:mikarinneoracle/simpleserver.git
          sed -i 's/simpleserver:.*#TAG/simpleserver:$WERCKER_MAIN_PIPELINE_STARTED #TAG/g' ./kustomize/deployment.yaml
          git add ./kustomize/deployment.yaml
          git commit -m 'tag changed'
          git push backtorepo master
